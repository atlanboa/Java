package broker.dao.impl;
/*
 * Exception ::
 * DuplicateSSNException,
 * RecordNotFoundException,
 * InvalidTransactionException
 * : 팔려는 주식의 숫자가 가지고 있는것 보다 더 많을떄
 */

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Vector;

import broker.dao.Database;
import broker.domain.CustomerRec;
import broker.domain.SharesRec;
import broker.domain.StockRec;
import broker.exception.DuplicateSSNException;
import broker.exception.InvalidTransactionException;
import broker.exception.RecordNotFoundException;
import config.ServerInfo;

public class DatabaseImpl implements Database {
	
	private static DatabaseImpl db = new DatabaseImpl("127.0.0.1");

	 private DatabaseImpl(String server){
		 
		 //throws 지우고 try catch 처리
		 try {
			Class.forName(ServerInfo.DRIVER_NAME);
			System.out.println("드라이버 로딩 성공...");
			
		} catch (ClassNotFoundException e) {
			System.out.println(e);
			System.out.println("드라이버 로딩 실패...");
		}
	 }
	 
	 public static DatabaseImpl getInstance() {
		 return db;
	 }
	 
	 //////// 공통적인 로직 /////////////////////
	 //얘네는 비지니스 로직 아님
	 public Connection getConnect() throws SQLException{
		Connection conn = null;
		conn = DriverManager.getConnection(ServerInfo.URL, ServerInfo.USER, ServerInfo.PASSWORD);
		System.out.println("디비 연결 성공...");
		 return conn;
	 }
	 
	 public void closeAll(PreparedStatement ps, Connection conn)throws SQLException{
		 if(ps != null) ps.close();
		 if(conn != null) conn.close();
	 }
	 public void closeAll(ResultSet rs,PreparedStatement ps, Connection conn)throws SQLException{
		 if(rs != null) rs.close();
			closeAll(ps, conn);
	 }
	 
	 
	 //////////////// 비지니스 로직 ////////////////////////////////////
	 public boolean isExist(String ssn) throws SQLException{ //private은 다른 클래스에서 못쓰자나 그래서 안됬던거
		Connection conn = getConnect();
		//특정한 ssn을 가지고 오는 쿼리
		//한국인은 int씀 있으면 1 없으면 0 이거보단 boolean이 나음
		String query = "select ssn from customer where ssn=?";
		PreparedStatement ps = conn.prepareStatement(query);
		ps.setString(1, ssn); //ssn 받았자나 멍청아
		ResultSet rs = ps.executeQuery();
		
		//while말고 if씀
		//if(rs.next()) 이거 할필요도 없음 걍 리턴할때 next가 true false 반환하니까 걍 리턴해줌
		return rs.next();
	 }
	 
	 public void addCustomer(CustomerRec cust)throws SQLException, DuplicateSSNException{
		Connection conn = null;
		PreparedStatement ps = null;
		try{
			conn = getConnect();
			if(!isExist(cust.getSsn())) { //고객이 없다면으로 해서 핵심 로직 넣어주고 예외처리는 뒤에 해주려함
			String query = "INSERT INTO customer (ssn, cust_name, address) VALUES(?, ?, ?)";
			ps = conn.prepareStatement(query);
	
			//바인딩이래 이걸
			ps.setString(1, cust.getSsn());
			ps.setString(2, cust.getName());
			ps.setString(3, cust.getAddress());
			
			System.out.println(ps.executeUpdate() + "row insert ok");
			}else {
				throw new DuplicateSSNException(cust.getName()+"님은 이미 회원입니다.");
			}
		}finally{
			closeAll(ps, conn);
		}				 
	 }
	 public void deleteCustomer(String ssn)throws SQLException,RecordNotFoundException{
		 Connection conn = null;
		 PreparedStatement ps = null;		 
		 try{
			

		 }finally{
			 closeAll(ps, conn);			 
		 }
	 }
	 public void updateCustomer(CustomerRec cust)throws SQLException, RecordNotFoundException{
		 Connection conn = null;
		 PreparedStatement ps = null;		
		 try{
			
		 }finally{
			 closeAll(ps, conn);
		 }
	 }

	 public ArrayList<SharesRec> getPortfolio(String ssn)throws SQLException{
		 Connection conn = null;
		 PreparedStatement ps = null;	
		 ResultSet rs = null;
		 ArrayList<SharesRec> v = new ArrayList<SharesRec>();
		 try{
				 
		 }finally{
			 closeAll(rs, ps, conn);
		 }
		 return v; 
	 }
	
	 public CustomerRec getCustomer(String ssn)throws SQLException{
		 Connection conn = null;
		 PreparedStatement ps = null;	
		 ResultSet rs = null;
		 CustomerRec cust = null;
		 try{
			
		 }finally{
			 closeAll(rs, ps, conn);
		 }
		 return cust;
	 }
	 public ArrayList<CustomerRec> getAllCustomers()throws SQLException{
		 Connection conn = null;
		 PreparedStatement ps = null;	
		 ResultSet rs = null;
		 ArrayList<CustomerRec> list = new ArrayList<CustomerRec>();
		 try{
			 			 
			 
		 }finally{
			 closeAll(rs, ps, conn);
		 }
		 return list;
	 }
	 
	 public ArrayList<StockRec> getAllStocks()throws SQLException{
		 Connection conn = null;
		 PreparedStatement ps = null;	
		 ResultSet rs = null;
		 ArrayList<StockRec> list = new ArrayList<StockRec>();
		 try{
			
		 }finally{
			 closeAll(rs, ps, conn);
		 }
		 return list;
	 }
	 
	 public float getStcokPrice(String symbol)throws SQLException,RecordNotFoundException{
		 Connection conn = null;
		 PreparedStatement ps = null;	
		 ResultSet rs = null;
		 float price = 0.0f;
		 
		 try{
			 
		 }finally{
			 closeAll(rs, ps, conn);
		 }
		 return price;
	 }

	 public void buyShares(String ssn, String symbol, int quantity)
	 				throws SQLException{
		 Connection conn = null;
		 PreparedStatement ps = null;	
		 ResultSet rs = null;
		 try{
			 
		 }finally{
			 closeAll(rs, ps, conn);
		 }
				 
	 }

	 public void sellShares(String ssn, String symbol, int quantity)
			 throws SQLException,RecordNotFoundException, InvalidTransactionException{
		 Connection conn = null;
		 PreparedStatement ps = null;	
		 ResultSet rs = null;
		 try{
			
		 }finally{
			 closeAll(ps, conn);			 
		 }
	 }
	 
	 public void updateStockPrice(String symbol, float price) throws SQLException{
		 Connection conn=  null;
		 PreparedStatement ps = null;
		 try{
			 
		 }finally{
			 closeAll(ps, conn);
		 }		 
	 }
}//class


















